目录
1 简介	4
1.1 编写目的	4
1.2 使用对象	4
1.3 产品范围	4
2 产品概述	5
2.1 总体框架	5
2.2 系统架构	5
2.3 模块描述	6
3 使用说明	7
3.1 业务流程说明	7
3.1.1 整体业务流程	7
3.1.2 交易处理流程	7
3.1.3 资源访问流程	8
3.2 功能模块说明	8
3.2.1 资源服务模块	8
3.2.2 交易服务路由模块	8
3.2.3 后台连接模块	9
3.2.4 通用服务模块	9
3.3 对外接口说明	9
3.3.1 与终端机系统接口	9
3.3.2 与银行后台服务系统接口	12
1简介
自国务院印发《推进普惠金融发展规划（2016—2020年）》通知以来，各省、自治区、直辖市人民政府、国务院各部委各直属机构积极响应，认真贯彻执行，普惠金融发展已经进入了高潮阶段，xxx公司紧跟时代潮流，推出了“xxxxx系统”，该系统作为终端机和xxxx的中间层，有效地将业务处理和技术平台结合起来，实现通讯管理、交易预处理、报文转换处理、交易合法性检查、金融业务等功能，极大的缓解了银行服务器的负荷，帮助银行高效的为社会各阶层和群体提供安全可靠的金融服务，提高我国金融服务的覆盖率。
1.1编写目的
本文档为使用说明文档，为产品的使用与维护提供信息基础。
1.2使用对象
本文档的使用对象主要为产品测试与使用人员。
1.3产品范围
本系统主要专注于为银行等金融公司提供前置处理服务，在该系统中实现通讯管理、交易预处理、报文转换处理、交易合法性检查、金融业务等功能，提前剔除了非法交易，实现报文转换，缓解银行服务器压力，主要包括如下模块，
1）资源服务模块：
包括资源的获取，更新和提交，主要面向STM/ATM终端提供服务。
2）交易服务路由模块：
包括具体交易的业务逻辑和交易路由。
3）后台连接模块：
包括报文转换、通讯管理和WISDOM平台组件。
4）通用服务模块：
包括终端验证、卡片验证、用户验证、交易日志、账户服务等。
及如下接口（对接到第三方系统），
1）与终端机系统接口：
通过该接口与自助终端机进行对接，终端机为其提供用户的交互数据。
2）与银行后台服务器系统接口：
通过该接口与银行服务器（ESB）进行对接，ESB为其提供交易数据。
2产品概述
2.1总体框架
Xxx处理系统（P）作为自助终端（C）和银行后台服务器（ESB）的中间层，总体框架如图2-1总体框架图所示。

图 2-1 总体框架图
2.2系统架构
本系统主要使用Apache Camel框架，主要开发语言为Java和Groovy，数据库采用的是Oracle。图2-2中，上半部分主要是接口和业务规则描述,其核心采用Apache Camel（ESB框架）实现。下半部分是公共服务，使用WISDOM平台组件或者基于平台进行项目扩展。资源服务层主要功能是面向STM/ATM终端提供服务。接口采用REST定义。交易服务路由层主要实现具体交易的业务逻辑和交易路由，如联网核查、业务签约、存取款等等。后台连接层实现与不同的后台系统进行交互,系统架构如图2-2所示。







图 2-2 系统架构图
2.3模块描述
资源服务模块
资源服务模块主要功能是面向STM/ATM终端提供服务。接口采用REST定义。终端可以通过调用这一层次获取资源、更新资源或者提交数据。例如，获取可以执行的交易列表、获取格式声明、上传客户身份证照片、提交交易请求等等。
交易服务路由模块
交易服务路由层主要实现具体交易的业务逻辑和交易路由，如联网核查、业务签约、存取款等等。交易服务通过Apache Camel的Groovy DSL实现。交易路由（发送到单一后台系统或者多个后台系统）在每个交易的Groovy DSL中描述。
后台连接模块
后台连接层实现与不同的后台系统进行交互。根据需要，报文转换及通讯管理可以通过Camel自带的模块或者WISDOM平台组件（Connector）实现，也可以在项目中进行实现和扩展。
通用服务模块
通用服务模块主要是提供公共服务，使用WISDOM平台组件或者基于平台进行项目扩展。主要是通过Java代码实现，提供终端验证、卡片验证、用户验证、交易日志、账务服务等功能。
3使用说明
3.1业务流程说明
3.1.1整体业务流程
详细流程如图3-1 交易时序图所示。
1）用户在xxxx的终端设备（C端）发起交易请求，终端设备生成交易报文并发送到我们的xxxxxxxx系统。
2）xxxxxx系统（P端）解析发送过来的报文，根据交易类型的不同对报文做不同的处理，按照ESB的规范封装报文，再将报文发送到ESB。
3）xxxxxx系统（P端）解析ESB返回的报文，根据交易类型的不同对报文做不同的处理，按照终端设备（C端）的需求封装报文并返回。
4）终端设备（C端）处理xxxxxxxx系统（P端）返回的报文，将交易结果展示给用户。

图 3-1 系统架构图
3.1.2交易处理流程
具体的交易流程如下：
1）资源服务层收到REST的post transaction请求，根据请求内容，创建交易对象，并将请求数据填入交易对象中，交易对象放入Exchange.in.body。
2）资源服务层将请求发送到transaction service Endpoint。
3）交易服务层中的交易分发路由接收包含交易对象的Exchange对象，根据交易对象要素，计算出需要交易入口Endpoint，并转发至该Endpoint。
4）交易服务层中，不同的交易逻辑分别定义各自的route和Endpoint入口（Consumer）。在route中可以直接通过process脚本对交易对象进行加工，也可以通过调用通用的服务对交易进行处理。当交易完成本地处理，需要进一步向后台系统发起授权请求时，路由转向相应后台系统Endpoint。
5）后台连接层中，不同的后台系统分别定义各自的route和Endpoint入口。根据后台系统的接入规范，调用Connector组件或者Camel的相关模块实现交易对象到报文格式的转换以及与后台系统的通讯。
3.1.3资源访问流程
资源访问采用REST的定义，通过HTTP get/put/post/patch/delete等方法完成。例如：
1）资源服务层收到REST的get请求，根据请求内容，可以调用相应的服务bean获取资源，也可以将请求转到route进行后续处理获取资源，并返回资源。
2）资源服务层收到REST的put或者patch请求，根据请求内容调用bean或者转到route进行资源更新。
3.2功能模块说明
3.2.1资源服务模块
资源服务模块主要功能是面向STM/ATM终端提供服务。接口采用REST定义。终端可以通过调用这一层次获取资源、更新资源或者提交数据。
本模块主要有以下两个功能：
发起交易请求
终端机通过调用该模块提供的接口，可以向交易服务路由层发起交易请求，将报文信息传送到到交易服务路由层进行处理。
上传/获取信息
终端机通过调用该模块提供的接口可以上传或下载格式声明、可执行交易列表等信息。
3.2.2交易服务路由模块
交易服务路由层主要实现具体交易的业务逻辑和交易路由，如联网核查、业务签约、存取款等等。交易服务通过Apache Camel的Groovy DSL实现。交易路由（发送到单一后台系统或者多个后台系统）在每个交易的Groovy DSL中描述。
本模块主要有以下两个功能：
交易路由分发功能
解析报文获取交易类型信息，根据交易类型将其分发到与之对应的路由上。
交易的业务逻辑处理
交易报文被分发到对应的交易路由之后即可开始业务逻辑处理，该模块将调用其他模块提供的接口，共同协作，完成业务逻辑的处理。
3.2.3后台连接模块
后台连接层实现与不同的后台系统进行交互。根据需要，报文转换及通讯管理可以通过Camel自带的模块或者WISDOM平台组件（Connector）实现，也可以在项目中进行实现和扩展。
本模块主要有以下两个功能：
报文转换功能
该模块可以对报文的格式进行转换，将交易服务路由模块传送过来的报文格式更改为符合银行规范的报文格式。
通讯功能
该模块可以通过Netty与银行后台服务器端建立TCP/IP链接，实现与银行后台服务器的通讯连接，互相传送报文信息。
3.2.4通用服务模块
通用服务模块主要是提供公共服务，使用WISDOM平台组件或者基于平台进行项目扩展，主要是通过Java代码实现。
本模块主要拥有以下功能：
终端验证功能
对终端进行校验，确认交易信息中的终端信息是来自本系统所对接的终端。
卡片验证功能
对卡片进行校验，确认当前交易卡是系统允许使用的卡类型，以及卡信息是否在卡表所配置值的正常范围内。
用户验证功能
对用户信息进行校验，确认用户名和密码是否匹配，用户信息是否正确。
交易日志功能
该模块可以将交易的时间、金额、状态、终端号、流水号等详细信息记录到日志中，再将日志信息同步到数据库
3.3对外接口说明
3.3.1与终端机系统接口
终端机是指用户直接操作的终端设备，可能是自动柜员机（ATM）或者智慧终端机（STM）等，普惠金融前置处理系统提供了与终端机进行交互通信的接口，以申请密钥为例，如下所示：
1）通讯包头参数，如表3-1所示。
表 3-1 通讯包头参数表
序号	字段名	长度	字段值	字段描述
1	DATA_LEN	4		该域后数据长度（ASCII）

2）交易包头参数，如表3-2所示。
表 3-2 交易包头参数表
序号	字段名	长度	字段值	字段描述
1	DEVICE_NO	20		设备号
2	TRS_CODE	3		交易代码
3	SER_NO	4		当前序列号
4	CYCLE_NO	4		当前批次号
5	CAST1_TYPE	1	0-5	钱箱1类型
6	CAST1_STAT	1	0-5	钱箱1状态
7	CAST1_LEFT	4		钱箱1的钞张数
8	CAST2_TYPE	1	0-5	钱箱2类型
9	CAST2_STAT	1	0-5	钱箱2状态
10	CAST2_LEFT	4		钱箱2的钞张数
11	CAST3_TYPE	1	0-5	钱箱3类型
12	CAST3_STAT	1	0-5	钱箱3状态
13	CAST3_LEFT	4		钱箱3的钞张数
14	CAST4_TYPE	1	0-5	钱箱4类型
15	CAST4_STAT	1	0-5	钱箱4状态
16	CAST4_LEFT	4		钱箱4的钞张数
17	CAST5_TYPE	1	0-5	钱箱5类型
18	CAST5_STAT	1	0-5	钱箱5状态
19	CAST5_LEFT	4		钱箱5的钞张数
20	CAST6_TYPE	1	0-5	钱箱6类型
21	CAST6_STAT	1	0-5	钱箱6状态
22	CAST6_LEFT	4		钱箱6的钞张数
23	CAST7_TYPE	1	0-5	钱箱7类型
24	CAST7_STAT	1	0-5	钱箱7状态
25	CAST7_LEFT	4		钱箱7的钞张数
26	CAST8_TYPE	1	0-5	钱箱7类型
27	CAST8_STAT	1	0-5	钱箱8状态
28	CAST8_LEFT	4		钱箱8的钞张数
29	JRN_STAT	1	0-3	日志打印机状态
30	REC_STAT	1	0-3	凭条打印机状态
31	DEP_STAT	1	0-2	信封存款模块状态
32	CDM_STAT	1	0-2	现金存款模块状态
33	PRN_STAT	1	0-2	宽行打印机模块状态(PP200明细）
34	BKP_STAT	1	0-2	存折补登机模块状态
35	CARD_STAT	1	0-2	读卡器状态
36	CWM_STAT	1	0-2	现金取款模块
37	DEM_STAT	1	0-2	加密
38	REV_STAT	8		保留硬件模块状态
39	DEV_STAT	1	O'or'C	设备运行状O—open ,C—close , 一般是‘O’

3）申请密钥参数，如表3-3所示。
表 3-3 申请密钥参数表
序号	字段名	长度	字段值	字段描述
1	DATA_LEN	4		通讯包头
2	BODY_HEAD	97		交易包头
3	RQK_MODE	1	‘C’or‘S	‘C’= 冷启动 ‘S’=管理员, 一般是‘C’
4	ATMCVER	8		版本号

4）交易成功返回参数，如表3-4所示。
表 3-4 交易成功返回参数表
序号	字段名	长度	字段值	字段描述
1	DATA_LEN	4		#通讯包头
2	RET_CODE	3	“ACD”	#返回码
3	DEVICE_NO	20		#设备号
4	SER_NO	4		#交易流水号
5	ACC_NO	22		#账号
6	TRANS_AMT	8		#交易金额
7	TRANS_FEEB	8		#手续费
8	HOST_SERIAL	12		#主机交易流水号
9	TRANS_ACC_DATE	8		#帐务日期(YYYYMMDD
10	ACT_FLG	1		实时标志
0-实时   1-非实时
(注：此标识只在TFR转账中使用)
11	MAC_FIELD	8		#MAC field

5）交易失败返回参数，如表3-5所示。
表 3-5 交易失败返回参数表
序号	字段名	长度	字段值	字段描述
1	DATA_LEN	4		#通讯包头
2	RET_CODE	3	“RJA”	#返回码
3	DEVICE_NO	20		#设备号
4	SER_NO	4		#交易流水号
5	ACC_NO	22		#账号
6	REJ_CODE	4		#拒绝码
3.3.2与银行后台服务系统接口
后台服务系统指进行交易数据处理的银行后台ESB系统，账户金额增减，用户信息的更改等操作都需要通过该系统来完成，以账户信息查询为例，参数如下所示：
1）账户信息查询请求参数，如表3-6所示。
表 3-6 账户信息查询请求参数表
请求方数据域名称	数据域中文名称	是否可以为空	数据域说明	定期账户信息查询
FUNC	功能	否	9：查询	9：查询
ACCT-NO	帐号	否	必输项；
活期/定期/卡/内部户/贷款账号	账号
CURR-COD	币别	是	详见数据字典-币别	可选输入，详见数据字典-币别和币种
CURR-IDEN	钞汇鉴别	是	0：钞
1：汇	可选输入
0：钞
1：汇
PSBK-NO	存折册号	是	存折册号	一本通账号需要送存折册号。
（送空只能查出账户类型，不能返回余额等信息）
PSBK-PRT-NO1	存折印刷号1	是	非必输	送空不校验；
否则校验存折印刷号是否正确
PSBK-SQ-NO	本册笔号	是	非必输	一本通账号用送存折笔号。
（查询某一笔账户信息，返回余额等信息）
CERT-TYP	证件种类	是	详见数据字典-证件类型	送空不校验；
否则校验（凭证件支取时）
CERT-ID	证件号码	是	证件号码	送空不校验；
否则校验（凭证件支取时）
SEC-MT-CON	二磁道	是	二磁道	可选输入，卡用
送值校验二磁
THD-MT-CON	三磁道	是	三磁道	空
PSWD	密码	是	密码	送空不验密；否则验密

2）账户信息查询响应参数，如表3-7所示。
表 3-7 账户信息查询响应参数表
请求方数据域名称	服务方数据域名称	数据域名称	数据域中文名称	数据域说明
SA-CUST-NAME	SSA20000_SA-CUST-NAME	SA-CUST-NAME	客户名称	客户名称
SA-OPEN-BUSN	SSA20000_SA-OPEN-BUSN	SA-OPEN-BUSN	开户机构	开户机构
SA-CUST-NO	SSA20000_SA-CUST-NO	SA-CUST-NO	客户编号	客户编号
SA-BAL	SSA20000_SA-BAL	SA-BAL	余额	活期存折余额；
卡活期的余额；
定活一本通某笔开户金额；
定期存单的开户金额；
零整教育储蓄类账户的实际金额；
（带小数点，左对齐，右补空格）
SA-OPEN-BUSN-NAME	SSA20000_SA-OPEN-BUSN-NAME	SA-OPEN-BUSN-NAME	开户行名称	开户行名称
SA-TRN-FLG	SSA20000_SA-TRN-FLG	SA-TRN-FLG	转存标志	转存标志
0：不自动转存
1：本息转存
2：本金转存
SA-NEW-ACCT-STS	SSA20000_SA-NEW-ACCT-STS	SA-NEW-ACCT-STS	账户状态	0：正常
1：销户
2：结清
3：待睡眠
4：睡眠
5：营业外
SA-FRZ-STS	SSA20000_SA-FRZ-STS	SA-FRZ-STS	冻结状态	0：正常
1：部分冻结
2：全部冻结
3：单向冻结
4：部分/全部冻结
5：部分/单向冻结
SA-CFRZ-STS	SSA20000_SA-CFRZ-STS	SA-CFRZ-STS	圈存状态	0：正常
1：圈存
SA-NEW-PSBK-STS	SSA20000_SA-NEW-PSBK-STS	SA-NEW-PSBK-STS	凭证状态	0：无存折/单
1：正常
2：有折未发
3：口头挂失
4：书面挂失
6：已申请
7：待制卡
8：待领
9：换卡注销
A：销户注销
SA-ENGULFED-STS	SSA20000_SA-ENGULFED-STS	SA-ENGULFED-STS	银行卡吞没状态	0：吞没
1：正常
SA-NEW-PSWD-STS	SSA20000_SA-NEW-PSWD-STS	SA-NEW-PSWD-STS	密码状态	0：无密码
1：初始密码
2：密码正常
3：密码锁定
4：密码挂失
SA-INTR-COD	SSA20000_SA-INTR-COD	SA-INTR-COD	利率依据	活期：
00：议价利率
01：牌告利率
02：浮动利率
03：输入利率
定期：
00：议价利率
01：牌告利率
02：随时浮动
03：定期浮动
SA-OPAC-CHANNEL-FLAG	SSA20000_SA-OPAC-CHANNEL-FLAG	SA-OPAC-CHANNEL-FLAG	开户渠道	详见数据字典-渠道
SA-POWER-NAME-FLG	SSA20000_SA-POWER-NAME-FLG	SA-POWER-NAME-FLG	强弱面签标志	0：弱
9：强
A：经过柜面确认，可以在本渠道下挂该账户
SA-ACCT-CHAR-CBUS-FLG	SSA20000_SA-ACCT-CHAR-CBUS-FLG	SA-ACCT-CHAR-CBUS-FLG	账户性质属性	1：基本账户
2：一般账户
3：专用账户
4：临时账户
5：个人结算
6：个人储蓄
7：其他
8：外管局账户性质
A：外币临时账户
SA-TEMP-ACC-DT	SSA20000_SA-TEMP-ACC-DT	SA-TEMP-ACC-DT	临时户失效日期	YYYYMMDD
SA-CURR-TYP	SSA20000_SA-CURR-TYP	SA-CURR-TYP	钞汇属性	0：钞
1：汇
SA-ACCT-BAL	SSA20000_SA-ACCT-BAL	SA-ACCT-BAL	账户余额	账户余额，针对新图形前端使用，外围不用此栏位
SA-CRBIZ-ACCT-NO	SSA20000_SA-CRBIZ-ACCT-NO	SA-CRBIZ-ACCT-NO	绑定账号	绑定账号
TD-DEP-DRW-CYCL-N	SSA20000_TD-DEP-DRW-CYCL-N	TD-DEP-DRW-CYCL-N	存入支取周期	存入支取周期
TD-DUEDT-PERIOD	SSA20000_TD-DUEDT-PERIOD	TD-DUEDT-PERIOD	距转存到期日天数	距转存到期日天数
PART-DRW-CNT	SSA20000_PART-DRW-CNT	PART-DRW-CNT	部提次数	部提次数
CERT-PRT-NO	SSA20000_CERT-PRT-NO	CERT-PRT-NO	原证实书号	原证实书号
