模块一：API 网关模块

API 网关模块负责对外提供统一的 HTTP 与 WebSocket 接口，承接前端业务流（注册/会话初始化、学习内容与测试任务获取、聊天求助、代码评测、进度查询、行为日志上报）并与后端各领域服务解耦编排。该模块以 FastAPI 为基础，集中管理路由装配、跨域策略、应用生命周期钩子与标准响应封装，确保接口的一致性与可维护性。模块入口位于 backend/app/main.py:1，通过在应用 lifespan 阶段启动 Redis 订阅协程（backend/app/core/redis_subscriber.py:1），将后端异步事件与 WebSocket 推送打通；并通过 CORS 中间件读取配置 settings.BACKEND_CORS_ORIGINS 实施跨域控制。所有具体业务路由在 backend/app/api/api.py:1 组装并以 settings.API_V1_STR 作为统一前缀暴露。

接口边界与职责明确。REST 路由涵盖：会话初始化（backend/app/api/endpoints/session.py:1，POST /session/initiate），对话求助（backend/app/api/endpoints/chat.py:1，POST /chat/ai/chat 同步模式；POST /chat/ai/chat2 与 GET /chat/ai/chat2/result/{task_id} 异步模式），代码评测（backend/app/api/endpoints/submission.py:1，POST /submission/submit-test 同步评测；POST /submission/submit-test2 与 GET /submission/submit-test2/result/{task_id} 异步评测），学习内容与测试任务（backend/app/api/endpoints/content.py:1，GET /learning-content/{topic_id} 与 GET /test-tasks/{topic_id}），用户进度查询（backend/app/api/endpoints/progress.py:1，GET /progress/participants/{participant_id}/progress），以及知识图谱读取（backend/app/api/endpoints/knowledge_graph.py:1，GET /knowledge-graph）。行为日志上报接口（backend/app/api/endpoints/behavior.py:1，POST /behavior/log）异步落库与解释，实现高吞吐低耦合。WebSocket 路由则通过 backend/app/api/endpoints/websocket.py:1 暴露 /ws/user/{participant_id}，用于与单用户建立持久连接，消息由 Redis Pub/Sub 渠道“ws:user:*”转发至连接的客户端。

输入输出采用 Pydantic 模型严格约束，并统一以 StandardResponse 泛型包装（backend/app/schemas/response.py:1），保证前后端契约稳定。示例包括：会话初始化的 SessionInitiateRequest/SessionInitiateResponse（backend/app/schemas/session.py:3），聊天的 ChatRequest/ChatResponse（backend/app/schemas/chat.py:87,112），学习内容与测试任务的 LearningContent 与 TestTask（backend/app/schemas/content.py:86,231），进度查询的 UserProgressResponse（backend/app/schemas/user_progress.py:39），行为事件的 BehaviorEvent（backend/app/schemas/behavior.py:152），以及提交评测的 TestSubmissionRequest/TestSubmissionResponse/TestSubmissionAsyncResponse（backend/app/schemas/submission.py:19,33,47）。对于异步接口（/chat/ai/chat2 与 /submission/submit-test2），网关立即返回 202 状态与任务 ID，客户端需通过对应 result 路由轮询；若 Celery 任务仍在进行，result 路由以 202 携带任务状态返回，任务完成后再返回标准数据载荷。

该模块与编排与任务系统松耦合集成。同步聊天路径在 /chat/ai/chat 中通过依赖注入获取 DynamicController 并协同用户状态、情感分析、RAG 检索与提示词生成后返回 AI 响应；异步聊天路径 /chat/ai/chat2 则投递至 chat_queue（backend/app/tasks/chat_tasks.py:12）。代码评测支持同步与异步双通道：同步接口 /submission/submit-test 直接调用沙箱进行断言评测并更新 BKT、进度与快照；异步接口 /submission/submit-test2 投递到 submit_queue，并在收到结果后由客户端轮询 result 路由获取。行为日志上报 /behavior/log 将事件分别投递到 db_writer_queue 与 behavior_queue，实现“先落库、再解释”的解耦流水线。Redis 订阅器 redis_subscriber 在应用生命周期内常驻，订阅“ws:user:*”通道并通过 WebSocketManager 将消息分发到在线用户连接，从而将后台任务的异步结果与前端实时体验闭环。

错误处理与降级策略在网关层明确。所有业务路由捕获输入校验异常并返回 400，内部异常统一返回 500；异步 result 路由对于未就绪任务使用 202 + status 进行提示。知识图谱接口在文件不存在或 JSON 解析失败时提供安全的空数据/默认节点回退（backend/app/api/endpoints/knowledge_graph.py:1），避免前端渲染中断。对话与评测接口在下游服务不可用时保持接口契约与语义（例如异步提交成功仍返回任务 ID），将具体故障交由后台任务与服务层处理。CORS 策略与 Asia/Shanghai 时区在应用层统一设置，保证跨域访问和时间线一致性（backend/app/main.py:1）。

配置项由 backend/app/core/config.py:1 暴露，包括 PROJECT_NAME、API_V1_STR、BACKEND_CORS_ORIGINS、BACKEND_PORT、REDIS_URL 等。依赖注入集中于 backend/app/config/dependency_injection.py:1，提供数据库会话、Redis 客户端、DynamicController、RAG/情感分析/聚类/沙箱等服务单例。模块不直接持久化数据，也不承载算法逻辑，其职责仅限协议编排、请求转发、标准化响应与生命周期管理，确保接口层清晰、稳定且便于演进。
