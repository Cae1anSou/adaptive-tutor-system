1. # 引言

近年来，随着国务院印发《关于深入实施“人工智能+”行动的意见》以及教育部大力推进教育数字化转型战略，人工智能与教育的深度融合已成为推动教育变革的核心驱动力。传统的“一刀切”式教学模式在培养学生创新思维和实践能力方面日益显现其局限性，难以满足新时代对高素质、复合型人才的需求。在此背景下，项目式学习（PBL）作为一种培养学生自主探究和解决复杂问题能力的高效模式，正受到教育界的高度重视。

为响应国家教育改革的号召，顺应技术发展的潮流，我们推出了“sync\_PBL智能教学系统”。该系统作为一个先进的智能化教学平台，将项目式学习（PBL）的教学理念与前沿的人工智能技术进行了深度融合。它通过实时追踪学习者行为、分析学习进度、并提供个性化的智能反馈与引导，有效地解决了传统PBL教学中难以规模化、缺乏个性化指导的痛点。本系统旨在为每一位学习者打造“一对一”的智能导师，极大地提升了学习的互动性、适应性和有效性，为培养具备创新能力和实践能力的未来人才提供了坚实的技术支撑。

2. # 设计概述
3. ## 系统概述

本系统是一个自适应动态 AI 教学系统，旨在为学习 Web 前端的编程初学者提供高度个性化的在线学习体验。与传统的静态 AI 教程不同，本系统的核心目标是解决静态教学无法实时感知学习者挫败感、认知负荷和知识盲区的问题。为实现这一目标，系统将通过前端界面实时捕获学习者的详细行为痕迹，后端则动态构建一个学习者的用户画像。该画像不仅包含基于贝叶斯知识追踪（BKT）模型更新的知识点掌握概率，还包含通过启发式规则引擎推断出的情感与行为状态，同时还使用了Bert模型来推断用户的情绪状态和使用本团队设计的聚类算法评估用户的学习进度。最终，系统利用此状态向量动态生成 Prompt，帮助AI在学习和编码测试界面中提供同步的、自适应的反馈，例如在用户沮丧时给予安抚，在用户困惑时提供更细致的讲解，从而实现一个闭环的个性化教学干预。

2. ## 编写目的

本文档为《syncPBL智能教学系统》的官方用户手册，旨在为本产品的最终用户，包括学习者与教学管理人员，提供详尽的操作指南和功能说明。通过阅读本手册，用户可以快速了解系统的核心功能、掌握各项操作流程、并高效地利用平台资源完成学习与教学任务。我们致力于通过这份文档，帮助用户扫清使用障碍，最大限度地发挥本智能教学系统的价值，从而获得流畅、高效、个性化的学习与教学体验。

3. ## 使用对象

* **开发人员**：开发人员将依据此处的架构设计、模块划分和接口定义来完成具体的编码实现工作。
* **测试工程师**：测试团队将参考本文档中的功能逻辑、业务流程和异常处理机制，来设计测试用例，验证系统功能是否符合设计规范和产品需求。
* **项目经理**：项目经理将使用本文档来明确 V1.0 的技术实现范围，评估开发工作量，协调团队资源，并以此为基准跟踪项目进度。
* **系统架构师与技术负责人**：负责审查本文档中的技术选型、架构风格和关键设计决策，确保系统设计的健壮性、可维护性以及对科研目标（如 A/B 测试和数据采集）的有效支持。

3. # 系统体系结构

本系统采用一套现代化的、分层解耦的微服务架构，旨在确保在高并发和长耗时AI推理场景下的稳定性、可扩展性与实时响应能力，架构自上而下分为用户层、接入层、应用层、存储层以及基础设施层。

1. 用户层与接入层：用户层是学生通过浏览器访问的前端应用界面。所有来自客户端的通信均通过接入层的Nginx服务器。Nginx在此扮演多重角色：它既是前端静态资源服务器，也是所有动态请求的统一入口和反向代理。它负责处理SSL/TLS加密、负载均衡，并将HTTP API请求和WebSocket长连接安全、高效地转发至后端的FastAPI应用层。
2. 应用层 ：应用层基于高性能的Python框架FastAPI构建，作为系统的后端核心。此层负责处理所有需要即时响应的请求。它不仅对外暴露了一系列核心RESTful API端点，还包含一个WebSocket端点，用于维护与客户端的持久化的全双工通信通道，实现AI的主动消息流式输出和异步任务（如评测结果）的非阻塞返回。
   在该架构中，主FastAPI应用扮演着生产者的角色。当用户提交一条聊天消息时，FastAPI主路由会立即执行轻量级操作，如前端请求页面内容时，FastAPI主路由会直接返回对应内容。但是如果是询问AI等CPU密集型操作时，它并不直接调用大语言模型或执行复杂的逻辑，而是将一个包含任务详情（如消息ID和用户上下文）的消息封装后，推送到Redis任务队列中。这个过程瞬间完成，使得主应用可以立刻处理下一个请求，从而维持了极高的并发处理能力和前端的流畅体验。

   为应对AI计算、代码评测和复杂数据分析等潜在的耗时操作，系统构建了多个微服务，并通过消息队列来串联，以Celery为分布式任务队列框架，并利用Redis作为消息代理。当FastAPI主后端收到耗时请求时，例如代码提交或用户行为追踪请求时，它仅是将任务推送到对应微服务的Celery队列便立即返回成功响应。这种即发即忘的模式确保了API接口的高并发和高吞吐量。Celery工作进程在后台独立地、可扩展地执行实际的计算逻辑。
3. 存储层**：** 存储层由Mysql和Redis构成。Mysql作为主数据库，负责持久化存储所有核心业务数据，包括用户信息、学习进度、完整的聊天记录和代码提交记录和评测结果等。Redis则扮演三个关键角色：1. Celery的消息代理；2. 用户数据的高速缓存，用于实时读写用户当前的情绪、专注度等动态画像；3. Pub/Sub发布订阅服务器，用于解耦异步任务和WebSocket通知。系统使用Annoy索引文件和JSON块存储预处理后的知识库向量及其原文，由RAGService在检索时调用。
4. 基础设施层：所有组件以 Docker 容器化部署，通过Docker-Compose编排文件进行一体化管理与弹性扩展。环境变量与配置中心统一管理关键参数与功能开关，支持在开发、测试与生产环境按需裁剪模块。容器化部署确保快速交付、隔离运行与可回滚升级，为系统的可靠运行与持续演进提供保障。而具体的部署操作系统则是采用业界主流的Linux服务器。此外，系统因为需要存储数据以及与外部交互，所以硬盘的网络也必不可少。

![](https://z0sf4crn7e0.feishu.cn/space/api/box/stream/download/asynccode/?code=MzE4YzEyMjhmNjQ0N2I3NzQwYmM3NzQ1M2JhYjk3NTBfTmtqTkNwTWNGMHFOU0FsSlVIdlY4QjdVbGl6VnZrbVNfVG9rZW46UG1kVmJTOGV3bzBzczZ4M0h1VmNRNHoybmdjXzE3NjIwODQxNDk6MTc2MjA4Nzc0OV9WNA)

图 21 系统架构图

1. ## ~模块描述~
2. ### ~AI~~对话微服务~

~celery-chat-worker 是本自适应导师系统的核心异步任务处理引擎，专门负责处理所有与~~AI~~对话相关的计算密集型和高延迟的后台操作。它的根本设计目标是将FastAPI主从耗时的任务中解放出来，从而保障~~用户界面~~的实时响应能力和系统的整体~~吞吐量~~。该服务基于强大的Celery框架，并利用Redis作为~~消息中间件~~，与主FastAPI应用构成了一个高效、~~解耦~~的生产者-消费者架构模式。~

~作为消费者，~~AI~~对话微服务在独立的进程中持续监听Redis队列。一旦接收到新任务，它便开始执行一系列复杂的后台处理流程。这包括从数据库中加载完整的对话历史，调用RAG服务从知识库中检索相关信息以增强上下文，执行由我们实现的~~聚类算法~~分析用户的学习进度，调用~~Bert~~模型来对用户的消息做~~情感分析~~，并最终构建一个精确的提示词来调用大语言模型~~API~~。由于调用外部~~LLM~~服务是整个流程中最耗时的环节，虽然FastAPI提供了协程的API，但是将其置于异步worker中执行更能保障系统性能。~

~ 任务完成后，结果的~~回传~~同样采用了一套~~异步通信~~机制：~~LLM~~ ~~API~~流式返回回答时，~~AI~~对话微服务会负责向Redis的发布/订阅频道发布一条条通知，前端中始终运行的WebSocket管理器作为订阅者，会即时收到该通知，并根据通知内容从Redis的频道中获取一段段AI回答，将结果实时、流式地推送给前端用户。这样设计确保了AI响应的实时响应，减少用户端的首字~~响应时间~~。AI对话微服务在LLM API传输完成之后，会将AI生成的完整回答持久化到数据库，至此完成整个AI调用过程。~

~在部署上，~~AI~~对话微服务作为一个独立的Docker容器运行，可以根据系统负载进行水平扩展。如果AI处理请求成为瓶颈，我们只需增加该微服务容器的数量即可提升处理能力，而无需改动或~~重启~~主Web服务。~

2. ### ~代码测试微服务~

~代码测试微服务承担着对用户提交的代码进行自动化评测的功能，旨在提供一个安全、隔离、公平且高效的~~执行环境~~。与处理~~AI~~对话的微服务类似，该服务同样基于Celery和Redis构建，遵循异步任务处理模式，从而将计算密集且存在安全风险的代码评测任务与主~~Web应用~~完全~~解耦~~，确保了主应用的高响应性和稳定性。~

~ 当用户在编程练习页面完成代码并点击提交时，前端会将代码发送至FastAPI后端。主应用作为任务的生产者，接收到请求后，并不会直接执行或评测这段可能存在风险的代码。相反，它会立刻将将包含用户代码、题目ID以及提交ID的关键信息打包成一个评测任务，将其异步地推送到Redis~~消息队列~~中。这一过程瞬间完成，前端可以立即收到“提交成功，正在评测”的反馈，而主服务器则被解放出来，继续服务于其他用户请求。~

~作为任务的消费者，代码评测微服务在独立的进程上持续监听任务队列。一旦获取到新的评测任务，它便会沙盒化执行每一次代码提交，服务会动态地创建一个全新的、完全隔离的Playwright~~无头浏览器~~。~

~在沙盒内部，系统会将用户的代码与该题目预设的检查点一同注入。随后它会执行评测脚本，通过运行这些~~测试用例~~来逐一验证用户代码的功能正确性、输出格式和边界条件。评测完成后，代码评测微服务会捕获所有~~标准输出~~、错误信息及最终的退出码，并解析评测脚本生成的结构化结果。~

~评测结果的处理与~~回传~~机制与~~AI~~对话模块相同，代码评测微服务会将详细的评测结果，包括哪些检查点通过、哪些失败以及具体的错误日志更新到数据库中对应的提交记录里。同时它会将同样的内容发布到Redis的发布/订阅频道。前端监听到频道中的消息后立即将其显示在前端，用户便能在界面上看到反馈。通过这种异步、沙盒化的设计，代码测试微服务不仅保障了整个平台的安全与稳定，更通过其独立的伸缩能力，为大规模用户同时进行编程实践提供了可靠的技术支撑。~

---

4. # 模块说明
5. ## 知识路径页面

系统提供了一个可以收起展开、包含全部学习内容的知识图谱，用户可以在该知识图谱页了解可以学习的所有内容。同时，用户可以根据知识结点的不同样式，来了解当前的学习进度。用户也可以根据自己的学习能力和兴趣选择跳过某些节点，系统会在用户学习跨度过大时要求用户进行测试，如果测试通过，用户即可跳跃学习；如若无法通过，则系统会要求用户按照原有路线学习。

![](https://z0sf4crn7e0.feishu.cn/space/api/box/stream/download/asynccode/?code=Mjk5ODE3MDFhYzM2YjFhZTQzODdlY2QzYWUxMzA3OTFfWE01NVR6bUxZeGFKOG1BVHNsQVRhR1VXMUl2dGVKOVRfVG9rZW46SDJvaGJJRUpxb2tvVkt4cUhUNmNDV1dWbkJoXzE3NjIwODQxNDk6MTc2MjA4Nzc0OV9WNA)

知识图谱页面是本自适应学习系统的核心导航界面，它承载着向学生直观展示课程结构、知识点依赖关系以及个人学习进度的关键功能。此模块的设计与实现旨在将后端的课程结构数据与前端的交互式可视化技术相结合，为学生提供一个清晰、动态且个性化的学习路径视图。本模块的实现主要分为后端数据服务、前端页面初始化、图谱可视化渲染与用户交互逻辑四个部分。

1. ### 后端数据接口实现

知识图谱的结构数据由后端通过一个专门的API端点提供。该接口采用Python的FastAPI框架构建，负责从服务器的数据目录中读取一个核心的JSON配置文件。此JSON文件定义了整个课程的节点和边：节点分为章节模块和知识点两种类型；边则定义了它们之间的连接关系。该文件还包含一个dependent\_edges列表，它明确了知识点之间严格的前后置学习依赖关系，这是实现自适应学习路径限制的基础。后端接口在读取文件后，会使用Pydantic模型对数据进行严格的格式校验，并通过全局缓存机制将解析后的数据缓存在内存中，以提高后续请求的响应性能。

2. ### **前端页面初始化与数据获取**

知识图谱页面的客户端逻辑由一个javascript程序文件驱动。当页面加载完成后，脚本首先执行初始化流程。它会从浏览器会话中获取当前学生的唯一标识participant\_id。随后，系统会并发执行两个异步数据请求：一是通过fetch调用后端接口获取课程的完整图谱结构；二是调用接口获取该特定学生的个人学习进度，此进度数据以一个包含所有已完成知识点ID的列表形式返回。

3. ### **图谱可视化渲染**

在成功获取图谱结构和学生进度数据后，前端开始进行可视化渲染。本系统选用Cytoscape.js库来绘制和操作知识图谱。渲染的核心逻辑被封装在GraphRenderer模块中。

首先，GraphRenderer初始化一个Cytoscape实例，并注入一组丰富的样式规则。这些规则定义了不同元素的视觉表现：例如，chapter类型的节点被渲染为较大的圆角矩形，而knowledge类型的节点为圆形。同时，样式表定义了多种状态类（.learned, .unlocked, .locked, .current），用于通过不同颜色（如绿色、蓝色、灰色、黄色）直观反映每个知识点的学习状态。

在图谱布局方面，系统将所有章节节点按照预定义的规则交错排列在上下两行，固定在画布的特定位置，确保了课程模块的主干结构清晰且稳定。在初始状态下，所有的章节内部的知识点节点默认是隐藏的。

最后，数据处理与状态应用。GraphState模块负责接收原始的图谱数据和用户进度数据，并根据dependent\_edges中定义的依赖关系，计算出每一个知识点对于当前用户的具体状态（已锁定、已解锁、已学习）。计算完成后，GraphRenderer中的函数被调用，这个函数遍历图谱中的所有节点，并根据GraphState的计算结果为它们应用对应的CSS状态类，从而完成图谱的渲染。

4. ### **核心交互逻辑实现**
5. 系统监听所有节点的点击事件。单击章节节点触发章节的展开与折叠功能。当用户点击可以展开的节点时，系统会计算并显示该章节下的所有知识点节点，并将它们布局在章节节点周围。当用户点击无法展开的节点时视为学生希望开始该章节的模块学习或测试。系统会调用相应的函数，根据学生是否已完成该章节或是否解锁前置章节，弹出不同的确认框，引导学生进行测试或学习。
6. **工具栏功能：** 页面中定义了一个包含放大、缩小和居中按钮的工具栏。这些按钮调用`GraphRenderer`中对应的Cytoscape API来实现视图控制。函数会自动计算所有可见节点的边界，并平滑地缩放和平移视图，使整个图谱在屏幕中居中显示。
7. ## 知识探索页面

![](https://z0sf4crn7e0.feishu.cn/space/api/box/stream/download/asynccode/?code=M2JlMjg0YjAxNjQzNjlkYWU1ZmVmNjBjMTk1ZGE5MTlfYTJtdVd4VVJrd3dVWUpFQVlNcVpudjlDcldHdEhNeFdfVG9rZW46VXNDemJKTEZUbzk5MHR4SzIzQmNFdGF4bkRkXzE3NjIwODQxNDk6MTc2MjA4Nzc0OV9WNA)

学习页面是学生学习和交互的主要场所，是本自适应辅导系统的功能核心。与传统静态教学页面不同，本页面深度集成了动态内容呈现、上下文感知的智能辅导以及实时的用户行为追踪三大功能。这些功能通过前后端服务的紧密协同，实现了从行为感知到智能反馈的自适应同步学习闭环。

1. ### 内容加载机制

为确保学生逐步构建知识体系，本系统采用了渐进式的学习内容加载机制，防止学生因一次性接触过多内容而产生认知过载。当学生从知识图谱重定向到本页面时，前端会首先从URL中解析出当前知识点ID。随后，它向后端的内容服务接口 /api/v1/content/{topic\_id} 发起异步数据请求。后端服务根据传入的topic\_id，在服务器的对应目录中定位并读取对应的JSON文件。此JSON文件以结构化数组的形式，定义了该知识点的所有学习单元，例如介绍、代码示例、详细解释和练习任务等。前端接收到JSON数据后，动态地将其渲染为HTML元素，并插入到页面中的容器中。

2. ### 选择预览功能

为了加强理论知识与代码实践效果之间的直观联系，本系统实现了一个可以让用户选择查看自己感兴趣的DOM元素的交互工具。为了实现这个效果，系统在页面布局中包含一个用于显示实时示例的<iframe>和一个用于显示代码片段的<pre>容器。系统的实时预览模块的核心功能是向<iframe>内部的文档动态注入一个脚本。该脚本会为<iframe>内的所有HTML元素绑定鼠标悬停和点击事件监听器。当用户鼠标悬停在<iframe>内的某个元素上时，该元素会动态添加一个高亮边框，以提示其可交互性。当用户点击该元素时，事件处理器会立即获取该元素及其子元素的完整HTML代码，并将其回传给父页面的特定函数。该函数随即将获取到的代码字符串更新到显示容器中，从而实现了让用户选择查看任意自己感兴趣的DOM元素的功能。

3. ### **同步AI系统**

同步AI系统是本模块最具创新性的部分，它通过一个基于RAG（检索增强生成）和拥有实时用户画像的后端AI微服务，为用户提供高度个性化的AI辅助。系统的页面中包含一个聊天窗口，当学生输入问题并点击发送时，前端立即将包含用户消息、participant\_id和当前用户学习内容的topic\_id的请求，通过HTTP发送至后端的/api/v1/chat接口。对话请求到达后端后，FastAPI路由会将完整的AI提问请求，放入专门负责AI对话的微服务的消息队列中，由AI对话微服务异步完成，同时FastAPI路由直接返回一个任务ID，方便前端在WebScoket中筛查当前请求的返回内容。

1. 系统中的Dynamic\_Controller是AI对话微服务的核心控制器，它首先构建一个极为丰富的上下文。此上下文不仅包含用户的当前问题和完整的聊天历史，还动态加载了学生*当前正在学习*的课程内容，做到可以“看到”用户正在学习的内容。同时， 用户的提问被向量化后，用于在预先构建的RAG索引中进行相似性搜索，检索出的相关知识片段被提取出来，加入此次提问的上下文，作为AI的外挂知识库。同时系统查询Redis中存储的用户画像信息，获取此刻该用户的画像，包括由行为追踪模块获取到的，由我们设计的聚类分析算法分析得出的学习进度和专注度等级，和通过Bert分析用户提问内容得到的用户情绪状态和相应置信度。

接着，系统将所有信息按照预先定义的提示词模板，组合成一个结构化的指令提示词。该提示词会明确指示大语言模型扮演一个有耐心的辅导老师角色，并要求它必须基于当前学生的困惑状态和正在学习的内容来回答问题。

1. 最后，将最终生成的提示词通过LLM调用模块调用外部LLM API并请求流式输出。收到LLM API接口返回的内容后，通过FastAPI的StreamingResponse功能，将LLM返回的token回传给前端。前端接收到token流，并动态渲染到聊天窗口，实现了流式输出效果。
2. 为确保响应速度，数据库的写入操作采用异步执行的方式，在响应流开始后，系统会调用数据库写入的微服务模块，在后台将完整的问答对话存入数据库表中，从而实现了完整的上下文持久化。
3. ### **实时行为追踪与画像构建**

为了使AI辅导和系统调整真正做到自适应，系统实现了一套精密的前端行为追踪与后端分析机制。

具体而言，系统在页面加载时会初始化行为追踪器模块。该追踪器在整个页面上附加了多种高频事件监听器，用于捕获用户的隐式行为，包括：滚动速度和位置、点击位置、复制内容、页面焦点变化以及基于idleThreshold定时器实现的空闲状态检测。

这些原始事件数据被暂存在客户端队列中。前端使用防抖和节流技术，将短时间内积累的事件数据打包成一个数组，通过fetch API批量异步发送到后端的/api/v1/behavior/track接口。

1. 后端的接口在接收到事件数组后，立即将其放入一个异步任务队列，之后由专门的行为分析微服务完成行为分析，同时快速返回成功响应，避免阻塞前端。行为分析微服务负责将低级别的原始用户行为事件流转换为具有教育学意义的标签，例如，在某个知识模块上长时间停留且无滚动被解释为深度阅读或卡住；在AI聊天中频繁提问则会显著提高困惑度指标。行为分析微服务在分析完毕后，会将这些标签被更新到Redis中的用户画像上，这个动态更新的用户画像最终被Dynamic\_Controller在下一次AI对话中调用，从而实现了实时自适应闭环。
2. ## 编程练习页面

![](https://z0sf4crn7e0.feishu.cn/space/api/box/stream/download/asynccode/?code=NzFlOWUxYzFmYTY5MTg3MTk4YmZjN2UwNTUzMWNmMmRfZmkxcjRnazU3bHRCb2N0Uk9nWUNCd2FLRGExa0lyV1NfVG9rZW46REl4b2Izb0c4b3lqTFh4aUxnNGNsU25lbkhjXzE3NjIwODQxNDk6MTc2MjA4Nzc0OV9WNA)

编程练习模块是系统的核心实践平台。它为学生提供了一个集成的在线编程环境，让用户解决与特定知识点强相关的编码任务。此模块的设计目标是提供一个包含即时反馈、自动评测和情境感知AI辅导的综合编码体验。其实现细节可分为前端IDE构建、自动化评测微服务、情境感知AI辅导以及主动式陪伴干预四个层面。

1. ### **前端IDE**

页面的左上角有一个任务描述面板用于加载和显示当前的编程题目要求，前端主脚本根据从URL解析的task\_id，通过/api/v1/content/{task\_id}接口动态获取任务数据。后端返回对应的JSON数据，其中详细定义了任务目标和检查点。

代码编辑器部分集成了Monaco Editor模块，可以为学生提供语法高亮、代码折叠和自动补全等功能。 为缩短学生的反馈回路，本模块在前端实现了两种反馈方式：

1. 代码静态检查： Monaco Editor模块在初始化时即配置了纯前端的代码静态分析功能。当学生编写代码时，前端会实时分析语法结构，对明显的语法错误立刻以波浪线形式进行提示，无需服务器参与，同时可以迅速高效地提醒用户，避免单词拼写错误等低级错误。
2. 实时预览： 系统提供了所见即所得的预览功能，前端会监听编辑器的内容变更事件，并通过防抖技术优化性能。当用户停止输入短暂时间后，预览模块会获取编辑器的完整代码，并将其写入实时预览窗口的srcdoc属性中，从而触发iframe的刷新，即时渲染出学生代码的视觉效果。
3. ### **自动化代码评测微服务**

为了对学生的编程实践能力进行客观、安全、可扩展的评估，本系统设计并实现了一套基于题目预先设定检查点的自动化代码评测微服务。

当学生点击提交按钮时，前端将用户的participantId、task\_id以及编辑器的完整代码封装为约定的JSON格式，然后POST至后端的/api/v1/submissions/接口。为确保API的高并发和快速响应，接口在将提交的数据异步存入数据库后，并不立即执行评测，而是通过消息队列将评测作业分发给专门负责代码测试的微服务，实现了评测逻辑的完全异步解耦化。

代码测试微服务的首要职责是提供一个安全、隔离的环境来分析用户提交的潜在不安全代码。考虑到安全性和资源隔离，理想的沙箱环境是基于Docker等容器化技术，在完全隔离的文件系统和网络环境中执行代码。在当前实现中，为兼顾轻量化和评测效率，系统采用了playwright无头浏览器作为沙盒，并提供了chromium环境。

1. 测试代码时， 代码评测微服务先从加载该题目的checkpoints数组。这些检查点是具体的、原子化的评测规则，因此可以单条逐步执行。服务会遍历所有检查点，并验证其属性或文本是否符合expected值。最终，代码评测微服务生成一份详细的JSON格式评测报告，其中包含每个检查点的通过或失败状态。这份报告被更新到数据库的提交记录中，并推送结果到Redis中，前端通过监听对应频道，使用WebScoket来获取相应结果到前端，至此完成整个代码评测流程。
2. ### **同步AI系统**

编程练习页面的同步AI系统在学习页面的基础上，通过注入更丰富的上下文，实现了更高维度的辅导能力。当学生提问时，前端脚本会动态抓取并发送一个包含整个页面数据快照的请求。该请求的数据包不仅包括用户的问题和participant\_id，还额外打包了用户当前尝试解决的题目ID、用户当前在编辑器中编写的代码以及当前显示的用户测试结果。

后端在收到这些丰富的上下文数据后，同样将完整的AI提问请求放入消息队列中，由AI对话微服务异步完成，同时后端直接返回一个任务ID，方便前端在WebScoket中筛查当前请求的返回内容。AI对话微服务在收到任务之后，同样由Dynamic\_Controller来统一调度，在学习页面处理逻辑的基础上，通过前端传递的题目ID索引到用户正在尝试解决的题目的完整信息，包括题目内容和所有检查点，全部加入AI上下文。之后的逻辑与学习页面中的一致，这里不再过多赘述。

这种全维度的情境感知能力，使得AI能够像真人教师一样，精确地指出学生代码中的具体错误与评测反馈之间的逻辑联系，从而提供高度针对性的调试建议。

4. ### **主动式陪伴与行为追踪**

与知识探索页面一样，编程练习页面也通同样有行为抓取功能。在此基础上，为了缓解学生在独立编程中可能产生的挫败感和孤独感，系统还实现了一套基于实时行为分析的主动式陪伴干预机制。系统不仅追踪常规的页面交互，还重点监听与编程任务强相关的事件，例如：代码修改的频率、大块代码的粘贴/删除行为、提交按钮的点击频率、以及在编辑器中的长时间无操作。

这些行为事件流被发送至后端的行为分析微服务进行实时分析。该服务通过启发式规则将特定行为序列解释为学生的潜在心理状态。例如，“5分钟内连续3次以上提交均失败”或“一次失败提交后，超过2分钟无任何键盘输入”等模式，会被判定为学生可能处于“沮丧”或“迷茫”状态。

这些负面状态一经识别，即被更新至Redis中的用户画像中，同时，前端界面中AI会立即发送一条非侵入的、鼓励性的引导消息，例如：“我注意到你似乎遇到了一些困难。需要我为你提供一个相关的提示吗？”。这种主动、适时的干预，旨在不打断用户心流的前提下，提供情感支持，有效提升学生的学习韧性和任务完成率。

4. ## 对外接口说明

表 3-1接口信息


| **模块**     | **方法** | **路径**                                                 | **摘要**              | **请求体**             | **成功响应**                                  | **其他状态** |
| ------------ | -------- | -------------------------------------------------------- | --------------------- | ---------------------- | --------------------------------------------- | ------------ |
| 会话         | POST     | /api/v1/session/initiate                                 | Initiate Session      | SessionInitiateRequest | StandardResponse[SessionInitiateResponse]     | 422          |
| 对话         | POST     | /api/v1/chat/ai/chat                                     | Chat With AI          | ChatRequest            | StandardResponse[ChatResponse]                | 422          |
| 对话异步提交 | POST     | /api/v1/chat/ai/chat2                                    | Chat With AI2         | ChatRequest            | StandardResponse[dict]{task\_id}              | 422          |
| 对话异步结果 | GET      | /api/v1/chat/ai/chat2/result/{task\_id}                  | Get Chat Result       | Path: task\_id         | StandardResponse[ChatResponse]                | 422          |
| 评测异步提交 | POST     | /api/v1/submission/submit-test2                          | Submit Test2          | TestSubmissionRequest  | StandardResponse[TestSubmissionAsyncResponse] | 422          |
| 评测异步结果 | GET      | /api/v1/submission/submit-test2/result/{task\_id}        | Get Submission Result | Path: task\_id         | StandardResponse[TestSubmissionResponse]      | 422          |
| 评测         | POST     | /api/v1/submission/submit-test                           | Submit Test           | TestSubmissionRequest  | StandardResponse[TestSubmissionResponse]      | 422          |
| 学习内容     | GET      | /api/v1/learning-content/{topic\_id}                     | Get Learning Content  | Path: topic\_id        | StandardResponse[LearningContent]             | 422          |
| 测试任务     | GET      | /api/v1/test-tasks/{topic\_id}                           | Get Test Task         | Path: topic\_id        | StandardResponse[TestTask]                    | 422          |
| 前端配置     | GET      | /api/v1/config/                                          | Get Frontend Config   | -                      | StandardResponse[FrontendConfig]              | -            |
| 学习进度     | GET      | /api/v1/progress/participants/{participant\_id}/progress | Get User Progress     | Path: participant\_id  | StandardResponse[UserProgressResponse]        | 422          |
| 知识图谱     | GET      | /api/v1/knowledge-graph                                  | Get Knowledge Graph   | -                      | StandardResponse[KnowledgeGraph]              | -            |
| 行为日志     | POST     | /api/v1/behavior/log                                     | 记录行为事件          | BehaviorEvent          | 202 Accepted（空 data）                       | 422          |

表 3-2标准响应包装


| **名称**            | **字段** | **类型**  | **说明**    |
| ------------------- | -------- | --------- | ----------- |
| StandardResponse[T] | code     | int       | 默认200     |
| StandardResponse[T] | message  | string    | 默认success |
| StandardResponse[T] | data     | T or null | 业务数据    |

表 33 会话接口数据结构


| **名称**               | **字段**        | **必填** | **类型/取值**              | **说明**                 |
| ---------------------- | --------------- | -------- | -------------------------- | ------------------------ |
| SessionInitiateRequest | participant\_id | 是       | string                     | 参与者唯一ID（UUID风格） |
| group                  | 否              | string   | 实验分组，默认experimental |                          |
| participant\_id        | 是              | string   | 返回的参与者ID             |                          |
| is\_new\_user          | 是              | boolean  | 是否为新用户               |                          |

表 34对话接口数据结构


| **名称**              | **字段**        | **必填**      | **类型/取值**               | **说明** |
| --------------------- | --------------- | ------------- | --------------------------- | -------- |
| ChatRequest           | participant\_id | 是            | string                      | 用户ID   |
| user\_message         | 是              | string        | 本轮用户输入                |          |
| mode                  | 否              | string        | 学习/测试等模式（若存在）   |          |
| content\_id           | 否              | string        | 当前内容或主题ID            |          |
| conversation\_history | 否              | array         | 既往对话（role/content）    |          |
| code                  | 否              | CodeContent   | 可选代码上下文（见“表5”） |          |
| answer                | 是              | string        | AI输出文本                  |          |
| references            | 否              | array[string] | RAG片段/来源                |          |
| strategy              | 否              | string        | 教学策略/语气等摘要         |          |
| diagnostics           | 否              | object        | 情感/进度等诊断摘要         |          |

表 35代码上下文（对话与任务通用）


| **名称**    | **字段** | **必填** | **类型/取值** | **说明** |
| ----------- | -------- | -------- | ------------- | -------- |
| CodeContent | html     | 否       | string        | HTML片段 |
| css         | 否       | string   | CSS片段       |          |
| js          | 否       | string   | JS片段        |          |

表 36代码评测请求与结果


| **名称**                    | **字段**        | **必填**    | **类型/取值**         | **说明**       |
| --------------------------- | --------------- | ----------- | --------------------- | -------------- |
| TestSubmissionRequest       | participant\_id | 是          | string                | 用户ID         |
| topic\_id                   | 是              | string      | 知识点/任务ID         |                |
| code                        | 是              | CodePayload | 代码负（HTML/CSS/JS） |                |
| CodePayload                 | html            | 否          | string                | HTML文本       |
| css                         | 否              | string      | CSS文本               |                |
| js                          | 否              | string      | JS文本                |                |
| TestSubmissionAsyncResponse | task\_id        | 是          | string                | 异步评测任务ID |
| TestSubmissionResponse      | passed          | 是          | boolean               | 是否全部通过   |
| message                     | 是              | string      | 总体评测反馈          |                |
| details                     | 是              | string[]    | 分项失败或提示信息    |                |

表 37学习内容


| **名称**          | **字段**  | **必填**          | **类型/取值**      | **说明** |
| ----------------- | --------- | ----------------- | ------------------ | -------- |
| LearningContent   | title     | 是                | string             | 主题标题 |
| description\_md   | 是        | string            | Markdown描述       |          |
| levels            | 否        | LevelInfo[]       | 难度/层级信息      |          |
| sc\_all           | 否        | SelectElementInfo | 示例页可选元素映射 |          |
| LevelInfo         | level     | 是                | int                | 等级编号 |
| description       | 是        | string            | 等级描述           |          |
| SelectElementInfo | topic\_id | 是                | string             | 主题ID   |
| select\_element   | 是        | string[]          | 可选元素选择器列表 |          |

表 38测试任务与检查点


| **名称**         | **字段**         | **必填**    | **类型/取值**                        | **说明**             |
| ---------------- | ---------------- | ----------- | ------------------------------------ | -------------------- |
| TestTask         | topic\_id        | 是          | string                               | 任务ID               |
| title            | 是               | string      | 标题                                 |                      |
| description\_md  | 是               | string      | 任务说明                             |                      |
| start\_code      | 是               | CodeContent | 初始代码                             |                      |
| Checkpoint       | name             | 是          | string                               | 检查点名称           |
| type             | 是               | enum        | 检查点类型                           |                      |
| feedback         | 是               | string      | 失败反馈                             |                      |
| selector         | 否               | string      | CSS选择器                            |                      |
| assertion\_type  | 是               | enum        | 断言方式（equals/contains/exists…） |                      |
| 交互类Checkpoint | action\_selector | 是          | string                               | 动作定位选择器       |
| action\_type     | 是               | enum        | click/type\_text/hover…             |                      |
| action\_value    | 否               | string      | null                                 | 动作值（如输入文本） |

表 39前端配置与学习进度


| **名称**       | **字段** | **必填** | **类型/取值**                   | **说明**                         |
| -------------- | -------- | -------- | ------------------------------- | -------------------------------- |
| FrontendConfig | -        | 否       | object                          | 前端所需开关与常量（按实现返回） |
| summary        | 否       | object   | 进度概览（按实现返回）          |                                  |
| details        | 否       | object   | 各主题/知识点进度（按实现返回） |                                  |

表 310知识图谱


| **名称**           | **字段** | **必填**             | **类型/取值**        | **说明**                        |
| ------------------ | -------- | -------------------- | -------------------- | ------------------------------- |
| KnowledgeGraph     | nodes    | 是                   | KnowledgeGraphNode[] | 节点                            |
| edges              | 是       | KnowledgeGraphEdge[] | 一般连边             |                                 |
| dependent\_edges   | 是       | KnowledgeGraphEdge[] | 依赖连边             |                                 |
| KnowledgeGraphNode | data     | 是                   | object               | 至少包含 id/label/metadata      |
| KnowledgeGraphEdge | data     | 是                   | object               | 至少包含 source/target/metadata |

表 311行为日志


| **名称**      | **字段**        | **必填** | **类型/取值**                | **说明** |
| ------------- | --------------- | -------- | ---------------------------- | -------- |
| BehaviorEvent | participant\_id | 是       | string                       | 用户ID   |
| event\_type   | 是              | string   | 事件类型（交互/求助/提交等） |          |
| payload       | 否              | object   | 事件数据                     |          |
| timestamp     | 否              | string   | ISO时间戳                    |          |
