<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元素选择+知识点展示</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="main-container">
      <!-- 顶部标题栏 -->
        <header class="top-header">
            <h1 class="header-title">标题</h1>
            <div class="user-profile">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRTVFNkU3Ii8+CjxjaXJjbGUgY3g9IjIwIiBjeT0iMTUiIHI9IjUiIGZpbGw9IiM4ODg4ODgiLz4KPHBhdGggZD0iTTIwIDI1QzE1IDI1IDEyIDI3IDEyIDMwTDI4IDMwQzI4IDI3IDI1IDI1IDIwIDI1WiIgZmlsbD0iIzg4ODg4OCIvPgo8L3N2Zz4K"
                    alt="用户头像" class="user-avatar">
            </div>
        </header>
        <div class="content-container">
          <!-- 左侧组合列（占 60% 宽） -->
          <div class="left-group">
            <!-- 上排：预览 + 代码（各占 50%） -->
            <div class="top-row">
              <!-- 左侧网页预览区 -->
              <div class="preview-panel">
                  <div class="ratio-16x9">
                    <iframe
                      id="element-selector-iframe"
                      src="../../backend/app/data/example_page/index01.html"
                    ></iframe>
                  </div>
              </div>
              <!-- 中间代码展示区（与预览等高） -->
              <div class="code-panel">
                <div class="panel-header">
                  <h2>代码展示</h2>
                </div>
                <div class="info-content" id="code-content">
                    <h2>选中元素代码</h2>
                    <pre id="selectedElementCode"></pre>
                </div>
                <!-- 代码展示面板底部的选择器控制区域 -->
                <div class="code-panel-footer">
                    <div class="selector-controls">
                        <button id="startSelector" class="btn btn-select">选取元素</button>
                        <button id="stopSelector" class="btn btn-select btn-stop-selector">停止选择</button>
                    </div>
                    <!-- 选择范围开关 -->
                    <div class="selector-toggle-container">
                        <label class="toggle-label">
                            <input type="checkbox" id="cumulativeToggle">
                            <span>包含之前章节的元素</span>
                        </label>
                        <div class="toggle-description">
                            开启后可选择当前及之前所有章节的元素，关闭时仅可选择当前章节元素
                        </div>
                    </div>
                </div>
              </div>
            </div>
            <!-- 下排：知识点（跨左+中列） -->
            <div class="knowledge-panel">
                <div class="panel-header">
                  <h2>知识点展示</h2>
                </div>
                <div class="info-content" id="knowledge-content">
                    <div class="levels-flow">
                        <div class="level-card">
                            <h3>Level 1 · 基础</h3>
                            <p class="content-text">适合零基础入门，掌握核心概念与基本语法。</p>
                        </div>
                        <div class="arrow" aria-hidden="true">➜</div>
                        <div class="level-card">
                            <h3>Level 2 · 进阶</h3>
                            <p class="content-text">理解常见场景与组合用法，提升实践能力。</p>
                        </div>
                        <div class="arrow" aria-hidden="true">➜</div>
                        <div class="level-card">
                            <h3>Level 3 · 高级</h3>
                            <p class="content-text">深入机制与性能优化，形成系统化认知。</p>
                        </div>
                        <div class="arrow" aria-hidden="true">➜</div>
                        <div class="level-card">
                            <h3>Level 4 · 挑战</h3>
                            <p class="content-text">综合实战与拓展题，检验与突破现有水平。</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary start-button">开始练习</button>
            </div>
          </div>

          <!-- 右侧 AI 对话（占 40% 宽，跨两行） -->
          <div class="chat-panel">
            <div class="panel-header">
              <h2>AI对话</h2>
            </div>
            <div class="chat-history">
              <div class="ai-chat-messages" id="ai-chat-messages">
                <div class="user-message">
                  <div class="user-content">
                        我想学习html的表格，请给我介绍一下，和外界html初学者
                  </div>
                </div>
                <div class="ai-message">
                  <div class="ai-content">
                    <div class="markdown-content">
                            当然可以！作为 HTML 初学者，学习"表格（Table）"是非常实用的一步。它能帮助你做网页中最常见的数据结构，比如成绩单、产品价格表等。<br><br><b>HTML 表格的基本结构</b><br>HTML 使用 <code>&lt;table&gt;</code> 标签来创建表格，基本结构如下：<br>
                            <pre class="code-example">&lt;table&gt;
                                &lt;tr&gt;
                                  &lt;th&gt;标题1&lt;/th&gt;
                                  &lt;th&gt;标题2&lt;/th&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                  &lt;td&gt;单元格1&lt;/td&gt;
                                  &lt;td&gt;单元格2&lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/table&gt;</pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="ai-chat-input">
              <!-- 聊天输入主区域 -->
              <div class="chat-input-main">
                <textarea id="user-message" placeholder="请输入信息"></textarea>
                <button type="button" id="send-message" class="btn btn-primary"
                  onclick="directSendMessage()">发送信息</button>
              </div>
            </div>
            <div class="status-container">
              <span id="statusBadge"></span>
            </div>
            <div class="status-container">
            </div>
          </div>
        </div>
    </div>

    <!-- 引入配置模块 -->
    <script src="../js/config.js"></script>
    <script type="module" src="../js/modules/config.js"></script>
    <!-- 引入选择模块 -->
    <script src="../js/modules/select_modules.js"></script>
    <!-- 引入文档模块 -->
    <script type="module" src="../js/modules/docs_module.js"></script>
    <!-- 引入learning_page.js -->
    <script src="../js/pages/learning_page.js"></script>
    
    <!-- 页面初始化脚本 -->
    <script type="module">
        import { initializeConfig, AppConfig } from '../js/modules/config.js';
        
        // 等待所有模块和AIHTMLPlatform加载完成
        function waitForModules() {
            if (window.SelectModules && window.DocsModule && window.AIHTMLPlatform && window.AIHTMLPlatform.initMainApp) {
                // 初始化主应用
                window.AIHTMLPlatform.initMainApp();
            } else {
                // 如果还没加载完成，等待100ms后重试
                setTimeout(waitForModules, 100);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先初始化配置
            await initializeConfig();
            console.log('当前模型：', AppConfig.model_name_for_display);
            
            // 添加回车键发送功能
            const messageInput = document.getElementById('user-message');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        directSendMessage();
                    }
                });
            }
            
            // 然后开始等待模块加载
            waitForModules();
        });
        
        // 发送消息函数（用于onclick事件）
        window.directSendMessage = async function() {
            const messageInput = document.getElementById('user-message');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('请输入消息内容');
                return;
            }
            
            // 禁用发送按钮，显示加载状态
            const sendButton = document.getElementById('send-message');
            const originalText = sendButton.textContent;
            sendButton.disabled = true;
            sendButton.textContent = '发送中...';
            
            try {
                // 添加用户消息到聊天界面
                addMessageToChat('user', message);
                
                                        // 发送消息到后端API
                        const response = await fetch(`${window.FrontendConfig.getApiBaseUrl()}/chat/ai/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        participant_id: 'user123', // 临时用户ID
                        user_message: message,
                        conversation_history: []
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 添加AI回复到聊天界面
                    addMessageToChat('ai', result.data.ai_response);
                } else {
                    throw new Error(result.message || 'AI回复失败');
                }
                
            } catch (error) {
                console.error('发送消息失败:', error);
                addMessageToChat('ai', '抱歉，我暂时无法回复，请稍后再试。');
            } finally {
                // 恢复发送按钮状态
                sendButton.disabled = false;
                sendButton.textContent = originalText;
                
                // 清空输入框
                messageInput.value = '';
            }
        }
        
        // 添加消息到聊天界面
        function addMessageToChat(role, content) {
            const chatMessages = document.getElementById('ai-chat-messages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user-message' : 'ai-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = role === 'user' ? 'user-content' : 'ai-content';
            
            if (role === 'ai') {
                const markdownDiv = document.createElement('div');
                markdownDiv.className = 'markdown-content';
                markdownDiv.innerHTML = content.replace(/\n/g, '<br>');
                contentDiv.appendChild(markdownDiv);
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>