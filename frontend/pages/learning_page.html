<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元素选择+知识点展示</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="main-container">
      <!-- 顶部标题栏 -->
        <header class="top-header">
            <h1 class="header-title">标题</h1>
            <div class="user-profile">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRTVFNkU3Ii8+CjxjaXJjbGUgY3g9IjIwIiBjeT0iMTUiIHI9IjUiIGZpbGw9IiM4ODg4ODgiLz4KPHBhdGggZD0iTTIwIDI1QzE1IDI1IDEyIDI3IDEyIDMwTDI4IDMwQzI4IDI3IDI1IDI1IDIwIDI1WiIgZmlsbD0iIzg4ODg4OCIvPgo8L3N2Zz4K"
                    alt="用户头像" class="user-avatar">
            </div>
        </header>
        <div class="content-container">
          <!-- 左侧网页预览区 -->
          <div class="preview-panel">
                             <iframe
                 id="element-selector-iframe"
                 src="../backend/app/data/example_page/index01.html"
                 style="width:100%;height:100%;border:none;flex:1 1 auto;min-height:0;"
               ></iframe>
          </div>
          <!-- 中间AI对话区 -->
          <div class="chat-panel">
            <div class="panel-header">
              <h2>AI对话</h2>
            </div>
            <div class="chat-history">
              <div class="ai-chat-messages" id="ai-chat-messages">
                <div class="user-message">
                  <div class="user-content">
                        我想学习html的表格，请给我介绍一下，和外界html初学者
                  </div>
                </div>
                <div class="ai-message">
                  <div class="ai-content">
                    <div class="markdown-content">
                            当然可以！作为 HTML 初学者，学习"表格（Table）"是非常实用的一步。它能帮助你做网页中最常见的数据结构，比如成绩单、产品价格表等。<br><br><b>HTML 表格的基本结构</b><br>HTML 使用 <code>&lt;table&gt;</code> 标签来创建表格，基本结构如下：<br>
                            <pre style="background:#f9f9f9;padding:8px;border-radius:4px;">&lt;table&gt;
                                &lt;tr&gt;
                                  &lt;th&gt;标题1&lt;/th&gt;
                                  &lt;th&gt;标题2&lt;/th&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                  &lt;td&gt;单元格1&lt;/td&gt;
                                  &lt;td&gt;单元格2&lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/table&gt;</pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="ai-chat-input">
              <button id="startSelector" class="btn btn-select">选取元素</button>
              <button id="stopSelector" class="btn btn-select btn-stop-selector">停止选择</button>
              <textarea id="user-message" placeholder="请输入信息"></textarea>
              <button type="button" id="send-message" class="btn btn-primary">发送信息</button>
            </div>
            <div style="padding: 0 32px 12px 32px;">
              <span id="statusBadge" style="display:none;font-size:13px;margin-right:12px;"></span>
            </div>
            <div style="padding: 0 32px 12px 32px;">
              <!-- 选择历史和元素信息已移除 -->
            </div>
          </div>
          <!-- 右侧知识点/代码区 -->
          <div class="info-panel">
              <div class="info-tabs">
                  <button class="info-tab active" id="tab-knowledge">知识点展示</button>
                  <button class="info-tab" id="tab-code">代码展示</button>
              </div>
              <div class="info-content" id="knowledge-content">
                  <!-- docs_module 知识点目录和内容将动态插入此处 -->
              </div>
              <div class="info-content" id="code-content" style="display:none;">
                  <h2>选中元素代码</h2>
                  <pre id="selectedElementCode" style="background:#f7f7f7;border-radius:6px;padding:10px;min-height:60px;border:1px solid #e0e0e0;"></pre>
                  <button id="showSourceBtn" style="margin-top:12px;padding:6px 16px;font-size:1rem;border-radius:6px;border:1px solid #2196f3;background:#fff;color:#2196f3;cursor:pointer;">返回源代码</button>
              </div>
              <div class="info-footer">
                  <div>
                      难度选择：
                      <select>
                          <option>简单</option>
                          <option>中等</option>
                          <option>困难</option>
                      </select>
                  </div>
                  <button class="btn btn-primary">开始练习</button>
              </div>
          </div>
        </div>
    </div>

    <!-- 引入配置模块 -->
    <script src="../js/config.js"></script>
    <script type="module" src="../js/modules/config.js"></script>
    <!-- 引入选择模块 -->
    <script src="../js/modules/select_modules.js"></script>
    <!-- 引入文档模块 -->
    <script type="module" src="../js/modules/docs_module.js"></script>
    <!-- 引入聊天集成模块 -->
    <script type="module" src="../js/modules/chat_integration.js"></script>
    <!-- 引入learning_page.js -->
    <script src="../js/pages/learning_page.js"></script>
    
    <!-- 页面初始化脚本 -->
    <script type="module">
        import { initializeConfig, AppConfig } from '../js/modules/config.js';
        import { post } from '../js/api_client.js';
        
        // 等待所有模块和AIHTMLPlatform加载完成
        function waitForModules() {
            if (window.SelectModules && window.DocsModule && window.AIHTMLPlatform && window.AIHTMLPlatform.initMainApp) {
                // 初始化主应用
                window.AIHTMLPlatform.initMainApp();
            } else {
                // 如果还没加载完成，等待100ms后重试
                setTimeout(waitForModules, 100);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先初始化配置
            await initializeConfig();
            console.log('当前模型：', AppConfig.model_name_for_display);
            
            // 初始化聊天集成模块
            try {
                const chatModule = await import('../js/modules/chat_integration.js');
                chatModule.initChatIntegration();
                console.log('Chat integration initialized successfully');
            } catch (error) {
                console.error('Failed to initialize chat integration:', error);
            }
            
            // 等待learning_page.js加载完成后再调用loadTracker
            setTimeout(async () => {
                if (window.loadTracker) {
                    await window.loadTracker();
                } else {
                    console.warn('loadTracker function not found');
                }
            }, 100);
            
            // 然后开始等待模块加载
            waitForModules();
        });
        
        // 发送消息函数将由chat_integration.js模块提供
        // 这里不再重复定义，避免冲突
        
        // 移除重复的addMessageToChat函数定义，使用chat_utils.js中的版本
    </script>
</body>
</html>