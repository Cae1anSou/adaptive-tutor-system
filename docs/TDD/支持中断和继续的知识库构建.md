# 支持中断和继续的知识库构建功能说明

## 概述

在处理大量文档时，知识库构建过程可能需要很长时间。如果在这个过程中发生中断（如系统崩溃、手动停止等），传统的构建脚本需要从头开始重新构建，这会浪费大量时间和资源。

为了解决这个问题，我们实现了支持中断和继续功能的知识库构建脚本。该脚本具有以下改进：

1. **即时中断响应**：能够快速响应Ctrl+C等中断信号
2. **检查点机制**：定期保存构建进度，包括已处理的文档、已生成的embeddings等
3. **中断恢复**：可以从上次中断的地方继续构建，无需重新开始
4. **信号处理**：优雅处理中断信号（如Ctrl+C），确保进度被正确保存
5. **命令行参数**：支持多种选项来自定义构建过程

## 功能特点

1. **即时中断响应**：在处理大量文档时，能够快速响应中断信号，避免长时间等待
2. **进度保存**：在关键节点自动保存构建进度，确保中断后不会丢失已完成的工作
3. **灵活恢复**：支持从任意检查点恢复构建，无需重新开始整个过程
4. **命令行参数**：提供多种选项来自定义构建过程

## 使用方法

### 基本使用

```bash
python backend/scripts/build_knowledge_base_resumable.py
```

### 命令行参数

- `--documents-dir`：指定文档目录路径（默认使用配置中的DOCUMENTS_DIR）
- `--force-restart`：强制重新开始构建（删除现有检查点）
- `--checkpoint-dir`：指定检查点目录路径（默认为项目根目录下的checkpoints目录）

### 示例

```bash
# 使用默认配置构建
python backend/scripts/build_knowledge_base_resumable.py

# 指定文档目录
python backend/scripts/build_knowledge_base_resumable.py --documents-dir ./my_documents

# 强制重新开始构建
python backend/scripts/build_knowledge_base_resumable.py --force-restart

# 指定检查点目录
python backend/scripts/build_knowledge_base_resumable.py --checkpoint-dir ./my_checkpoints
```

## 中断和恢复

### 如何中断

在构建过程中，可以通过以下方式中断：
- 按 `Ctrl+C`
- 发送 `SIGTERM` 信号

### 如何恢复

要从上次中断的地方继续构建，只需重新运行相同的命令，不要使用 `--force-restart` 参数：

```bash
python backend/scripts/build_knowledge_base_resumable.py
```

系统会自动检测到检查点文件并从中断处继续构建。

### 强制重新开始

如果需要从头开始构建，使用 `--force-restart` 参数：

```bash
python backend/scripts/build_knowledge_base_resumable.py --force-restart
```

## 技术实现

### 核心组件

1. **BuildState类**：管理构建状态和检查点
2. **KnowledgeBaseBuilderImpl类**：修改后的知识库构建器，支持检查点机制
3. **ResumableKnowledgeBaseBuilder类**：支持中断和继续的构建器包装类

### 检查点文件

检查点信息保存在以下文件中：
- `build_state.json`：构建状态信息
- `embeddings.json`：已生成的embeddings数据

### 工作流程

1. 启动构建脚本
2. 检查是否存在有效的检查点
3. 如果存在检查点且未完成，则从检查点恢复进度
4. 如果不存在检查点或强制重新开始，则从头开始构建
5. 在构建过程中定期保存检查点
6. 如果收到中断信号，保存当前进度并退出
7. 构建完成后标记为完成状态

## 注意事项

1. 检查点文件会占用额外的磁盘空间
2. 在构建过程中不要手动删除检查点文件
3. 如果文档内容发生变化，建议使用 `--force-restart` 参数重新构建